From 76d46db1696f6a28f911b7ecad39f91616eb4c18 Mon Sep 17 00:00:00 2001
From: "guochu.yi" <guochu.yi@sophgo.com>
Date: Thu, 11 Sep 2025 20:40:39 +0800
Subject: [PATCH 2/2] [feat] set RTC wakeup source

Change-Id: If971421ffe35a81b9d95844f45e27699b9e1278b
---
 plat/cvitek/cv184x/common/bl2_load.c | 25 +++++++++++++++++++++++++
 1 file changed, 25 insertions(+)

diff --git a/plat/cvitek/cv184x/common/bl2_load.c b/plat/cvitek/cv184x/common/bl2_load.c
index c87e14b..e72ec2d 100644
--- a/plat/cvitek/cv184x/common/bl2_load.c
+++ b/plat/cvitek/cv184x/common/bl2_load.c
@@ -924,6 +924,30 @@ void fip_src_check(void)
 	}
 }
 
+/* RTC 唤醒源设定
+ * AI相机项目中，RTC唤醒源为 PWR_BUTTON1, PWR_WAKEUP0
+ */
+void rtc_wakeup_config(void)
+{
+	/* 唤醒源设定 */
+	mmio_write_32(0x03001098, 0); // 切pinmux为 PWR_BUTTON1
+	mmio_write_32(0x03001090, 0); // 切pinmux为 PWR_WAKEUP0
+
+	mmio_write_32(0x05027084, 0); // 锁定pinmux为 PWR_BUTTON1
+	mmio_write_32(0x0502708c, 0); // 锁定pinmux为 PWR_WAKEUP0，防止poweroff时被重置
+
+	mmio_write_32(0x050250ac, 0x2); // 设定 poweroff 时 rtc 不复位
+	mmio_write_32(0x050260d0, 0x3); // 不自动开机
+	mmio_write_32(0x050260bc, 0x1100); // RTC_EN_PWR_WAKEUP 设定唤醒源为 PWR_BUTTON1、PWR_WAKEUP0
+	// 设定触发模式，PWR_BUTTON1 为低电平触发，
+	// PWR_WAKEUP0 为上升沿触发（默认是高电平触发，会导致poweroff下去，立马又开机）
+	mmio_write_32(0x0502606c, 0x16);
+	/* 强制重启功能 */
+	mmio_write_32(0x05026004, 0x800000); // 这个默认值就是0x800000，但不设定一下，又起不来。
+	mmio_write_32(0x05026050, 0xdc780007); // 设定长按时间，7s
+	mmio_write_32(0x050260b8, 0xdc78000b); // 使能强制重启功能
+}
+
 int load_rest(void)
 {
 	int retry = 0;
@@ -999,6 +1023,7 @@ retry_from_flash:
 	console_flush();
 
 	switch_rtc_mode_2nd_stage();
+	rtc_wakeup_config();
 
 	NOTICE("M/%lx/N/%lx/", monitor_entry, loader_2nd_entry);
 	if (monitor_entry) {
-- 
2.25.1

